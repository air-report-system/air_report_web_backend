# 订单CSV导出功能使用说明

## 功能概述

订单CSV导出功能允许用户按月导出订单数据为标准CSV格式文件，支持中文字符，兼容Excel等常用办公软件。

## API接口

### 基本信息
- **接口路径**: `/api/v1/orders/export`
- **HTTP方法**: `GET`
- **认证要求**: 需要用户登录认证
- **响应格式**: CSV文件下载

### 请求参数

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| month | string | 是 | 导出月份，格式：YYYY-MM | 2024-01 |

### 使用示例

#### 1. 导出2024年1月订单
```bash
curl -X GET "/api/v1/orders/export?month=2024-01" \
  -H "Authorization: Token your_auth_token" \
  -o "orders_2024_01.csv"
```

#### 2. 导出2024年12月订单
```bash
curl -X GET "/api/v1/orders/export?month=2024-12" \
  -H "Authorization: Token your_auth_token" \
  -o "orders_2024_12.csv"
```

#### 3. 在浏览器中直接下载
```
https://your-domain.com/api/v1/orders/export?month=2024-01
```

## CSV文件格式

### 文件特性
- **编码格式**: UTF-8 with BOM（支持Excel直接打开中文）
- **字段分隔符**: 逗号（,）
- **文件扩展名**: .csv
- **文件命名**: `订单导出_YYYY年MM月_YYYYMMDD_HHMMSS.csv`

### 字段说明

| 字段名 | 说明 | 数据类型 | 示例 |
|--------|------|----------|------|
| 订单ID | 订单唯一标识符 | 整数 | 1001 |
| 客户姓名 | 客户姓名 | 文本 | 张三 |
| 客户电话 | 客户联系电话 | 文本 | 13800138001 |
| 客户地址 | 客户地址信息 | 文本 | 北京市朝阳区测试地址1号 |
| 商品类型 | 产品类型 | 文本 | 国标/母婴 |
| 成交金额 | 订单金额 | 数值 | 1500.00 |
| 面积 | 检测面积 | 文本 | 100 |
| 履约时间 | 服务履行日期 | 日期 | 2024-01-15 |
| CMA点位数量 | 检测点位数量 | 文本 | 5 |
| 备注赠品 | 备注信息 | 文本 | 赠送检测报告 |
| 创建时间 | 订单创建时间 | 日期时间 | 2024-01-10 14:30:22 |

### CSV示例
```csv
订单ID,客户姓名,客户电话,客户地址,商品类型,成交金额,面积,履约时间,CMA点位数量,备注赠品,创建时间
1,张三,13800138001,北京市朝阳区测试地址1号,国标,1500.0,100,2024-01-15,5,赠送检测报告,2024-01-10 14:30:22
2,李四,13800138002,上海市浦东新区测试地址2号,母婴,2000.0,120,2024-01-20,6,,2024-01-15 09:15:30
```

## 响应状态码

| 状态码 | 说明 | 响应内容 |
|--------|------|----------|
| 200 | 成功 | CSV文件下载 |
| 400 | 参数错误 | `{"error": "month参数格式错误，应为YYYY-MM格式"}` |
| 401 | 未认证 | `{"detail": "Authentication credentials were not provided."}` |
| 404 | 无数据 | `{"error": "2024年1月没有订单数据"}` |
| 500 | 服务器错误 | `{"error": "导出失败: 具体错误信息"}` |

## 注意事项

### 1. 数据筛选规则
- 只导出指定月份的订单（基于`履约时间`字段）
- 只导出有效订单（`is_active=True`）
- 按履约时间和创建时间排序

### 2. 性能考虑
- 大数据量导出可能需要较长时间
- 建议单次导出不超过10万条记录
- 支持并发导出，但建议控制并发数量

### 3. 权限要求
- 需要登录认证
- 只能导出当前用户有权限访问的订单数据

### 4. Excel兼容性
- 使用UTF-8-BOM编码，确保Excel能正确显示中文
- 字段格式已优化，适合Excel直接打开
- 数值型字段会自动识别为数字格式

## 错误处理

### 常见错误及解决方案

1. **参数格式错误**
   ```json
   {"error": "month参数格式错误，应为YYYY-MM格式"}
   ```
   **解决**: 确保month参数格式为YYYY-MM，如2024-01

2. **月份超出范围**
   ```json
   {"error": "month参数格式错误，应为YYYY-MM格式: 月份必须在1-12之间"}
   ```
   **解决**: 确保月份在01-12范围内

3. **无数据**
   ```json
   {"error": "2024年1月没有订单数据"}
   ```
   **解决**: 确认指定月份是否有订单数据，或更换查询月份

4. **认证失败**
   ```json
   {"detail": "Authentication credentials were not provided."}
   ```
   **解决**: 确保请求头包含有效的认证信息

## 技术实现

- **框架**: Django REST Framework
- **查询优化**: 使用数据库索引加速日期筛选
- **内存管理**: 流式CSV生成，支持大数据量导出
- **字符编码**: UTF-8-BOM确保跨平台兼容性